<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¥çµŒè¡°å¼±ã‚²ãƒ¼ãƒ </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
</head>
<body>
    <script>
        let rows = 8, cols = 8; // 8Ã—8ã®ã‚«ãƒ¼ãƒ‰ï¼ˆåˆè¨ˆ64æšï¼‰
        let cardSize = 100; // ã‚«ãƒ¼ãƒ‰ã‚µã‚¤ã‚º
        let cards = [];
        let flippedCards = [];
        let matchedPairs = 0;
        let images = {};
        let selectedPairs = []; // é¸ã°ã‚ŒãŸ32ãƒšã‚¢ã‚’æ ¼ç´
        let startTime, clearTime, gameOver;
        let clearTimeText = "";
        let replayButton, screenshotButton;

        // **116ãƒšã‚¢ï¼ˆ232æšï¼‰ã®å…¨å€™è£œ**
        let allPairs = Array.from({ length: 117 }, (_, i) => i + 1)
                    .filter(n => ![56, 88].includes(n)) // â† 56,88ç•ªã‚’é™¤å¤–ï¼
                    .map(n => [`${n}.png`, `A${n}.png`]);

        function preload() {
            images["back"] = loadImage("cards/back.png?v=" + Date.now()); // è£é¢

            // 117ãƒšã‚¢åˆ†ã®ç”»åƒã‚’äº‹å‰ã«ãƒ­ãƒ¼ãƒ‰
            for (let pair of allPairs) {
                images[pair[0]] = loadImage("cards/" + pair[0] + "?v=" + Date.now());
                images[pair[1]] = loadImage("cards/" + pair[1] + "?v=" + Date.now());
            }
        }

        function setup() {
            createCanvas(cols * cardSize, rows * cardSize + 150);
            initializeGame();
        }

        function initializeGame() {
            cards = [];
            flippedCards = [];
            matchedPairs = 0;
            clearTimeText = "";
            gameOver = false;

            // **112ãƒšã‚¢ã‹ã‚‰32ãƒšã‚¢ã‚’ãƒ©ãƒ³ãƒ€ãƒ é¸æŠ**
            shuffle(allPairs, true); // å…¨ãƒšã‚¢ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
            selectedPairs = allPairs.slice(0, 32); // å…ˆé ­ã®32ãƒšã‚¢ã‚’ä½¿ç”¨

            let tempCards = [];
            for (let pair of selectedPairs) {
                tempCards.push({ id: pair[0], img: images[pair[0]], pair: pair[1] });
                tempCards.push({ id: pair[1], img: images[pair[1]], pair: pair[0] });
            }
            shuffle(tempCards, true);
            for (let i = 0; i < rows; i++) {
                for (let j = 0; j < cols; j++) {
                    let index = i * cols + j;
                    cards.push({ x: j * cardSize, y: i * cardSize, ...tempCards[index], flipped: false, matched: false });
                }
            }

            startTime = millis();
            clearTime = null;

            if (replayButton) replayButton.remove();
            replayButton = createButton("ğŸ”„ ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤");
            replayButton.position(width / 2 - 60, height - 60);
            replayButton.mousePressed(initializeGame);
            replayButton.hide();

            if (screenshotButton) screenshotButton.remove();
            screenshotButton = createButton("ğŸ“¸ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ’®ã‚‹");
            screenshotButton.position(width / 2 - 80, height - 30);
            screenshotButton.mousePressed(takeScreenshot);
            screenshotButton.hide();
        }

        function draw() {
            background(255);
            for (let card of cards) {
                if (card.flipped || card.matched) {
                    image(card.img, card.x, card.y, cardSize, cardSize);
                } else {
                    image(images["back"], card.x, card.y, cardSize, cardSize);
                }
            }

            let elapsedTime = gameOver ? clearTime : millis() - startTime;
            let formattedTime = formatTime(elapsedTime);

            fill(0);
            textSize(24);
            textAlign(CENTER, CENTER);
            text(`â±ï¸ çµŒéæ™‚é–“: ${formattedTime}`, width / 2, height - 110);
            text(clearTimeText, width / 2, height - 80);
        }

        function mousePressed() {
            if (flippedCards.length >= 2 || gameOver) return;

            for (let card of cards) {
                if (!card.flipped && !card.matched && mouseX > card.x && mouseX < card.x + cardSize &&
                    mouseY > card.y && mouseY < card.y + cardSize) {
                    card.flipped = true;
                    flippedCards.push(card);
                    
                    if (flippedCards.length === 2) {
                        setTimeout(checkMatch, 1000);
                    }
                    break;
                }
            }
        }

        function checkMatch() {
            let [card1, card2] = flippedCards;
            if (card1.pair === card2.id) {
                card1.matched = true;
                card2.matched = true;
                matchedPairs++;
                if (matchedPairs === selectedPairs.length) {
                    clearTime = millis() - startTime;
                    clearTimeText = `ğŸ‰ ã‚¯ãƒªã‚¢ã‚¿ã‚¤ãƒ : ${formatTime(clearTime)}`;
                    gameOver = true;

                    replayButton.show();
                    screenshotButton.show();
                }
            } else {
                card1.flipped = false;
                card2.flipped = false;
            }
            flippedCards = [];
        }

        function takeScreenshot() {
            let filename = `memory_game_${clearTimeText.replace(/[^0-9]/g, "_")}.png`;
            saveCanvas(filename, 'png');
        }

        function formatTime(ms) {
            let totalSeconds = Math.floor(ms / 1000);
            let minutes = Math.floor(totalSeconds / 60);
            let seconds = totalSeconds % 60;
            return `${minutes}åˆ†${seconds}ç§’`;
        }
    </script>
</body>
</html>
